//@version=6
indicator("GEX Master Auto V5: 20251221", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// === SETTINGS ===
var float width_scale = input.float(0.5, "Bar Width Scale", minval=0.1, step=0.1)
var float text_size_threshold = input.float(1000000, "Text Label Threshold (Notional)", tooltip="Only show labels where GEX > this value")
var float strike_range_pct = input.float(15.0, "Visible Range %", minval=1.0, step=1.0, tooltip="Only draw lines within this % of the current price. Reduces lag and clutter.")
var bool show_dashboard = input.bool(true, "Show Dashboard")

// === STORAGE FOR DRAWING OBJECTS ===
var line[] drawn_lines = array.new_line()
var label[] drawn_labels = array.new_label()

// === DATA LOADING ===
load_data() =>
    string sym = syminfo.ticker
    float[] s = array.new_float(0)
    float[] g = array.new_float(0)
    // -- AUTO-GENERATED DATA BLOCKS START --

    if sym == "SPY"
        s := array.from(210, 215, 220, 225, 230, 235, 240, 245, 250, 255, 260, 265, 270, 275, 280, 285, 290, 295, 300, 305, 310, 315, 320, 325, 330, 335, 340, 345, 350, 355, 360, 365, 370, 375, 380, 385, 390, 395, 400, 405, 410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490, 495, 500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565, 570, 575, 580, 585, 590, 595, 600, 605, 610, 615, 620, 621, 622, 623, 624, 625, 626, 627, 628, 629, 630, 631, 632, 633, 634, 635, 636, 637, 638, 639, 640, 641, 642, 643, 644, 645, 646, 647, 648, 649, 650, 651, 652, 653, 654, 655, 656, 657, 658, 659, 660, 661, 662, 663, 664, 665, 666, 667, 668, 669, 670, 671, 672, 673, 674, 675, 676, 677, 678, 679, 680, 681, 682, 683, 684, 685, 686, 687, 688, 689, 690, 691, 692, 693, 694, 695, 696, 697, 698, 699, 700, 701, 702, 703, 704, 705, 706, 707, 708, 709, 710, 711, 712, 713, 714, 715, 716, 717, 718, 719, 720, 725, 730, 735, 740, 745, 750, 755, 760, 765, 770, 775, 780, 785, 790, 795, 800, 805, 810, 815, 820, 825, 830, 835, 840, 850, 930, 955, 970, 975, 980, 985, 995, 1000)
        g := array.from(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1825013, 1218286, 1544179, 1322220, 1091618, 2017295, 1580934, 5781534, 1588148, 13047692, 6346197, 2387022, 3750626, 3586046, 5443458, 160428, 226246, 411109, 331201, 8909915, 221209, 647021, 206643, 286959, 9339946, 160155, 841141, 293085, 120542, 14585065, 383339, 552275, 300913, 328207, 30224245, 338961, 5057056, 508441, 8649772, 15941114, 6666985, 11604929, 386061, 4264649, 57545539, 5731847, 691263, 9414137, 8925774, 23494027, 795401, 1078345, 1085220, 1070926, 40573248, 614418, 651036, 506467, 973798, 31054496, 1027910, 854209, 620475, 764228, 44628122, 528588, 1222846, 7611108, 1981765, 43065225, 2035605, 2033835, 3915614, 3342171, 30599416, 1658867, 5214285, 1582908, 2304936, 44969398, 2562968, 2333863, 3429634, 2962167, 30737928, 1708691, 1202291, 2610613, 1675407, 18856044, 1617076, 1168871, 1557588, 1624563, 38004494, 2033495, 1759467, 1835018, 1480607, 11329199, 1076508, 560306, 863330, 260550, 10177820, 392732, 494148, 270896, 267901, 4251580, 153553, 168459, 247482, 126804, 3816580, 2634232, 1279136, 1405327, 1426631, 708755, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

    if sym == "QQQ"
        s := array.from(174.78, 179.78, 184.78, 189.78, 194.78, 199.78, 204.78, 209.78, 214.78, 219.78, 224.78, 229.78, 234.78, 239.78, 244.78, 249.78, 254.78, 259.78, 264.78, 269.78, 274.78, 279.78, 284.78, 289.78, 294.78, 299.78, 304.78, 309.78, 314.78, 319.78, 324.78, 329.78, 334.78, 339.78, 344.78, 349.78, 354.78, 359.78, 364.78, 369.78, 370.0, 374.78, 379.78, 380.0, 384.78, 389.78, 390.0, 394.78, 399.78, 400.0, 404.78, 409.78, 410.0, 414.78, 419.78, 420.0, 424.78, 429.78, 430.0, 434.78, 439.78, 440.0, 444.78, 449.78, 450.0, 454.78, 459.78, 460.0, 464.78, 469.78, 470.0, 474.78, 479.78, 480.0, 484.78, 489.78, 490.0, 494.78, 499.78, 500.0, 504.78, 509.78, 510.0, 514.78, 519.78, 520.0, 524.78, 529.78, 530.0, 534.78, 539.78, 540.0, 544.78, 549.78, 550.0, 554.78, 559.78, 560.0, 564.78, 569.78, 570.0, 574.78, 579.78, 580.0, 584.78, 589.78, 590.0, 594.78, 599.78, 600.0, 604.78, 609.78, 610.0, 615.0, 620.0, 625.0, 630.0, 635.0, 640.0, 645.0, 650.0, 655.0, 660.0, 665.0, 670.0, 675.0, 680.0, 685.0, 690.0, 695.0, 700.0, 705.0, 710.0, 715.0, 720.0, 725.0, 730.0, 735.0, 740.0, 745.0, 750.0, 755.0, 760.0, 765.0, 770.0, 775.0, 780.0, 785.0, 790.0)
        g := array.from(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 137773, 557820, 557450, 209899, 2007623, 356928, 250251, 1224169, 559239, 134935, 822139, 988356, 474341, 4989351, 809984, 604280, 3040773, 2342834, 1190173, 13264606, 1508232, 3094328, 8045796, 3134617, 2765719, 11232056, 6359192, 2952420, 19396314, 6781460, 4994842, 17433360, 8616882, 5217390, 61815672, 21017394, 5189502, 28944913, 25876067, 29367613, 35900426, 33473188, 16412550, 22011241, 2622145, 13928549, 4582014, 1977514, 1233363, 1994605, 777469, 932086, 364455, 497972, 0, 185, 0, 0, 0, 0, 0, 0, 0, 0, 0, 370, 0, 0, 0, 0, 0, 0, 0, 0)

    if sym == "BITO"
        s := array.from(3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50)
        g := array.from(55438, 466, 64272, 1911, 6726, 4324, 31214, 732762, 146121, 1582490, 1818139, 1792267, 1296554, 633653, 380581, 741353, 251131, 872570, 141882, 186340, 168861, 105581, 344602, 40555, 53271, 51103, 9976, 177073, 12399, 10695, 15797, 8049, 211704, 19410, 13873, 38974, 20959, 1559, 7940, 5115, 2470, 14369, 4788, 5292, 2297, 17332, 274604)

    if sym == "BBAI"
        s := array.from(0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0)
        g := array.from(540, 14574, 50724, 42879, 14946, 190201, 410228, 1357226, 899746, 3472206, 2588356, 5484829, 6001398, 4248265, 754239, 2239958, 266137, 450210, 66771, 37960, 261633, 63833, 237438)

    if sym == "RR"
        s := array.from(1, 2, 3, 4, 5, 6, 7, 8)
        g := array.from(0, 3107, 252276, 569235, 720698, 142901, 42661, 3327)

    if sym == "BMNU"
        s := array.from(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24)
        g := array.from(13, 4780, 10145, 46080, 58021, 135412, 338743, 80380, 50625, 497833, 134296, 159621, 3399, 1920, 392, 1030, 138, 99, 416, 953, 2530, 796, 607)

    if sym == "MSTU"
        s := array.from(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 25)
        g := array.from(0, 0, 0, 0, 30063, 0, 0, 0, 18477, 41936, 219292, 7236, 11481, 1533, 59536, 493, 0, 0, 4908, 21496, 0, 30, 29024)

    if sym == "OPEN"
        s := array.from(0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0, 21.0)
        g := array.from(7012, 84, 109255, 524, 215462, 14141, 167794, 74807, 647946, 657035, 530264, 970776, 2018293, 1159265, 1598744, 742240, 359930, 48552, 7581, 15251, 29509, 10406, 28531, 137213, 15628, 357233, 1292925)

    // -- AUTO-GENERATED DATA BLOCKS END --
    [s, g]

// === MAIN LOGIC ===
if barstate.islast
    // 1. CLEAR OLD DRAWINGS
    // Essential for keeping chart clean when data updates
    while array.size(drawn_lines) > 0
        line.delete(array.pop(drawn_lines))
    while array.size(drawn_labels) > 0
        label.delete(array.pop(drawn_labels))

    [strikes, gex_vals] = load_data()
    
    // === V5 RANGE FILTER ===
    // We calculate a "Safe Zone" around the current price.
    // Lines outside this zone are NOT drawn. This keeps us under the 500 line limit.
    float upper_bound = close * (1 + strike_range_pct / 100)
    float lower_bound = close * (1 - strike_range_pct / 100)
    
    if array.size(strikes) > 0
        float max_gex = 0.0
        float total_gex = 0.0

        // Calculate Max/Total first
        for i = 0 to array.size(gex_vals) - 1
            val = array.get(gex_vals, i)
            total_gex += val
            if math.abs(val) > max_gex
                max_gex := math.abs(val)

        // === Improved Gamma Visualization ===
        for i = 0 to array.size(strikes) - 1
            s_price = array.get(strikes, i)
            g_val = array.get(gex_vals, i)

            // === V5 FILTER LOGIC ===
            // Only proceed if the strike is relevant to current price action
            if s_price >= lower_bound and s_price <= upper_bound

                // Draw line for each strike
                color bar_color = g_val > 0 ? color.new(color.green, 0) : color.new(color.red, 0)
                color label_color = g_val > 0 ? color.green : color.red
                
                // Infinite Grid Lines (extend.both) anchored to TIME (safer than bar_index)
                line l = line.new(time, s_price, time + 1, s_price, 
                                  xloc=xloc.bar_time, extend=extend.both, 
                                  color=bar_color, width=2)
                array.push(drawn_lines, l)

                // Label Logic
                if math.abs(g_val) >= text_size_threshold
                    // 3-Way Stagger to prevent overlap
                    // We use time-based offset (approx 12 hours * multiplier)
                    int x_offset_ms = 1000 * 60 * 60 * 12
                    if i % 3 == 1
                        x_offset_ms := x_offset_ms * 2
                    else if i % 3 == 2
                        x_offset_ms := x_offset_ms * 3
                    
                    string txt = str.tostring(s_price) + "\n" + str.tostring(math.round(g_val / 1000000)) + "M"
                    
                    // Locked to Price (yloc.price)
                    label lbl = label.new(time + x_offset_ms, s_price, txt, 
                                          xloc=xloc.bar_time, yloc=yloc.price, 
                                          style=label.style_label_left,
                                          textcolor=color.white, color=color.new(label_color, 40), size=size.normal)
                    array.push(drawn_labels, lbl)

        // === Dashboard Summary ===
        if show_dashboard
            string regime = total_gex > 0 ? "Short Vol (Pos GEX)" : "Long Vol (Neg GEX)"
            color reg_col = total_gex > 0 ? color.green : color.red
            var table dash = table.new(position.top_right, 1, 1)
            table.cell(dash, 0, 0,
                syminfo.ticker + " GEX: " + str.tostring(math.round(total_gex/1000000)) +
                "M\n" + regime + "\nDate: 20251221",
                text_color=color.white, bgcolor=color.new(reg_col, 80))
    else
        var table err = table.new(position.bottom_right, 1, 1)
        table.cell(err, 0, 0, "No GEX Data for " + syminfo.ticker,
                   text_color=color.white, bgcolor=color.gray)
