//@version=6
indicator("GEX Master Auto: 20251221", overlay=true, max_boxes_count=500, max_labels_count=500)

// === SETTINGS ===
var float width_scale = input.float(0.5, "Bar Width Scale", minval=0.1, step=0.1)
var float text_size_threshold = input.float(1000000, "Text Label Threshold (Notional)", tooltip="Only show labels where GEX > this value")
var bool show_dashboard = input.bool(true, "Show Dashboard")

// === STORAGE FOR DRAWING OBJECTS ===
// We use arrays to store the lines/labels so we can delete them before redrawing.
// This prevents "ghost" lines that seem to float or stick when scrolling.
var line[] drawn_lines = array.new_line()
var label[] drawn_labels = array.new_label()

// === DATA LOADING ===
load_data() =>
    string sym = syminfo.ticker
    float[] s = array.new_float(0)
    float[] g = array.new_float(0)
    // -- AUTO-GENERATED DATA BLOCKS START --

    if sym == "SPY"
        s := array.from(210, 210, 215, 215, 220, 220, 225, 225, 230, 230, 235, 235, 240, 240, 245, 250, 250, 255, 255, 260, 260, 265, 270, 270, 275, 275, 280, 280, 285, 290, 290, 295, 295, 300, 300, 305, 305, 310, 310, 315, 315, 320, 320, 325, 325, 330, 330, 335, 335, 340, 340, 345, 345, 350, 350, 355, 355, 360, 360, 365, 365, 370, 370, 375, 375, 380, 380, 385, 385, 390, 390, 395, 395, 400, 400, 405, 405, 410, 410, 415, 415, 420, 420, 425, 425, 430, 430, 435, 435, 440, 440, 445, 445, 450, 450, 455, 455, 460, 460, 465, 465, 470, 470, 475, 475, 480, 480, 485, 485, 490, 490, 495, 495, 500, 500, 505, 505, 510, 510, 515, 515, 520, 520, 525, 525, 530, 530, 535, 535, 540, 540, 545, 545, 550, 550, 555, 555, 560, 560, 565, 565, 570, 570, 575, 575, 580, 580, 585, 585, 590, 590, 595, 595, 600, 600, 605, 605, 610, 610, 615, 615, 620, 620, 621, 621, 622, 622, 623, 623, 624, 624, 625, 625, 626, 626, 627, 627, 628, 628, 629, 629, 630, 630, 631, 631, 632, 632, 633, 633, 634, 634, 635, 635, 636, 636, 637, 637, 638, 638, 639, 639, 640, 640, 641, 641, 642, 642, 643, 643, 644, 644, 645, 645, 646, 646, 647, 647, 648, 648, 649, 649, 650, 650, 651, 651, 652, 652, 653, 653, 654, 654, 655, 655, 656, 656, 657, 657, 658, 658, 659, 659, 660, 660, 661, 661, 662, 662, 663, 663, 664, 664, 665, 665, 666, 666, 667, 667, 668, 668, 669, 669, 670, 670, 671, 671, 672, 672, 673, 673, 674, 674, 675, 675, 676, 676, 677, 677, 678, 678, 679, 679, 680, 681, 682, 683, 684, 685, 686, 687, 688, 689, 690, 691, 692, 693, 694, 695, 696, 697, 698, 699, 700, 701, 702, 703, 704, 705, 706, 707, 708, 709, 710, 711, 712, 713, 714, 715, 716, 717, 718, 719, 720, 725, 730, 735, 740, 745, 750, 755, 760, 765, 770, 775, 780, 785, 790, 795, 800, 805, 810, 815, 820, 825, 830, 835, 840, 850, 930, 955, 970, 975, 980, 985, 995, 1000)
        g := array.from(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1825013, 1218286, 0, 0, 1544179, 1322220, 0, 0, 1091618, 2017295, 0, 0, 1580934, 5781534, 0, 0, 1588148, 13047692, 0, 0, 6346197, 0, 2387022, 0, 3750626, 0, 3586046, 378438, 5065019, 157637, 2790, 1089, 225157, 410837, 272, 136, 331065, 8494449, 415465, 408, 220801, 646612, 408, 1089, 205554, 284509, 2450, 777160, 8562786, 158930, 1225, 204, 840936, 1089, 291996, 119453, 1089, 1259737, 13325327, 191941, 191397, 5445, 546830, 298530, 2382, 325484, 2722, 24428893, 5795351, 2858, 336102, 4778127, 278928, 2450, 505991, 8356959, 292813, 11996095, 3945018, 2858, 6664127, 11603976, 952, 378438, 7623, 4900, 4259748, 41913574, 15631965, 2450, 5729397, 688812, 2450, 17764, 9396372, 8902632, 23141, 5424740, 18069287, 786553, 8848, 2246, 1076099, 1074738, 10481, 2994, 1067932, 32891488, 7681759, 14701, 599716, 637151, 13885, 7078, 499389, 960526, 13272, 11254260, 19800235, 979312, 48598, 33351, 820857, 593794, 26681, 24503, 739724, 30370311, 14257811, 49006, 479582, 1014841, 208005, 268990, 7342117, 1351216, 630549, 20992180, 22073045, 965290, 1070314, 741698, 1292136, 2041118, 1874496, 1875653, 1466517, 30599416, 1658867, 5214285, 1582908, 2304936, 44969398, 2562968, 2333863, 3429634, 2962167, 30737928, 1708691, 1202291, 2610613, 1675407, 18856044, 1617076, 1168871, 1557588, 1624563, 38004494, 2033495, 1759467, 1835018, 1480607, 11329199, 1076508, 560306, 863330, 260550, 10177820, 392732, 494148, 270896, 267901, 4251580, 153553, 168459, 247482, 126804, 3816580, 2634232, 1279136, 1405327, 1426631, 708755, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

    if sym == "QQQ"
        s := array.from(174.78, 174.78, 179.78, 179.78, 184.78, 184.78, 189.78, 189.78, 194.78, 194.78, 199.78, 199.78, 204.78, 204.78, 209.78, 209.78, 214.78, 219.78, 224.78, 229.78, 229.78, 234.78, 234.78, 239.78, 239.78, 244.78, 249.78, 254.78, 259.78, 264.78, 269.78, 274.78, 274.78, 279.78, 284.78, 289.78, 289.78, 294.78, 299.78, 299.78, 304.78, 309.78, 309.78, 314.78, 314.78, 319.78, 319.78, 324.78, 324.78, 329.78, 329.78, 334.78, 334.78, 339.78, 339.78, 344.78, 349.78, 349.78, 354.78, 354.78, 359.78, 359.78, 364.78, 364.78, 369.78, 369.78, 370.0, 370.0, 374.78, 374.78, 379.78, 379.78, 380.0, 380.0, 384.78, 389.78, 389.78, 390.0, 390.0, 394.78, 394.78, 399.78, 400.0, 400.0, 404.78, 404.78, 409.78, 409.78, 410.0, 410.0, 414.78, 414.78, 419.78, 419.78, 420.0, 420.0, 424.78, 424.78, 429.78, 429.78, 430.0, 430.0, 434.78, 434.78, 439.78, 439.78, 440.0, 440.0, 444.78, 444.78, 449.78, 449.78, 450.0, 450.0, 454.78, 454.78, 459.78, 460.0, 460.0, 464.78, 464.78, 469.78, 470.0, 470.0, 474.78, 474.78, 479.78, 479.78, 480.0, 480.0, 484.78, 484.78, 489.78, 489.78, 490.0, 490.0, 494.78, 494.78, 499.78, 499.78, 500.0, 500.0, 504.78, 504.78, 509.78, 509.78, 510.0, 510.0, 514.78, 514.78, 519.78, 519.78, 520.0, 520.0, 524.78, 524.78, 529.78, 529.78, 530.0, 530.0, 534.78, 534.78, 539.78, 539.78, 540.0, 540.0, 544.78, 544.78, 549.78, 549.78, 550.0, 550.0, 554.78, 554.78, 559.78, 559.78, 560.0, 560.0, 564.78, 564.78, 569.78, 569.78, 570.0, 570.0, 574.78, 574.78, 579.78, 579.78, 580.0, 580.0, 584.78, 584.78, 589.78, 589.78, 590.0, 590.0, 594.78, 594.78, 599.78, 599.78, 600.0, 600.0, 604.78, 604.78, 609.78, 609.78, 610.0, 610.0, 615.0, 615.0, 620.0, 620.0, 625.0, 625.0, 630.0, 630.0, 635.0, 635.0, 640.0, 640.0, 645.0, 645.0, 650.0, 650.0, 655.0, 655.0, 660.0, 660.0, 665.0, 665.0, 670.0, 670.0, 675.0, 675.0, 680.0, 680.0, 685.0, 685.0, 690.0, 690.0, 695.0, 700.0, 700.0, 705.0, 710.0, 715.0, 720.0, 725.0, 730.0, 735.0, 740.0, 745.0, 750.0, 750.0, 755.0, 755.0, 760.0, 760.0, 765.0, 770.0, 775.0, 780.0, 785.0, 790.0)
        g := array.from(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 137773, 0, 557820, 0, 76753, 480696, 33625, 176274, 2007623, 0, 194968, 161959, 225509, 24741, 1224169, 0, 514137, 45101, 117043, 17892, 190526, 631612, 163317, 825039, 316022, 158319, 3749571, 1239779, 703985, 105998, 507659, 96620, 418442, 2622330, 2021259, 321575, 969538, 220635, 3639007, 9625599, 1270012, 238219, 1771501, 1322826, 7900680, 145116, 2278235, 856382, 1886138, 879580, 185837, 11046218, 1181289, 5177903, 1880894, 1071526, 692756, 18703558, 5580551, 1200909, 1845787, 3149055, 15368789, 2064571, 3671090, 4945791, 2298040, 2919349, 19766138, 42049534, 10976992, 10040401, 2369364, 2820137, 17331495, 11613417, 12777986, 13098080, 9158229, 20209384, 23578149, 12322277, 7652897, 25820291, 12147916, 4264634, 3614080, 18397161, 2448092, 174052, 914379, 13014170, 4445783, 136231, 1690305, 287208, 23198, 1210164, 1990656, 3948, 10859, 766610, 921721, 10365, 7588, 356867, 497972, 0, 0, 0, 185, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 370, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

    if sym == "BITO"
        s := array.from(3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 30, 31, 32, 32, 33, 33, 34, 35, 35, 36, 36, 37, 37, 38, 40, 40, 41, 42, 43, 43, 44, 45, 45, 46, 46, 47, 47, 48, 48, 49, 49, 50, 50)
        g := array.from(0, 55438, 455, 10, 71, 64200, 1849, 62, 0, 6726, 4324, 0, 8029, 23185, 717015, 15747, 12237, 133883, 880859, 701631, 1208319, 609820, 399634, 1392632, 628204, 668349, 247272, 386381, 232012, 148568, 122504, 618849, 115804, 135327, 530846, 341724, 40745, 101136, 136969, 49370, 54316, 114545, 82672, 22908, 147456, 197145, 27996, 12558, 20994, 32276, 41608, 9494, 259, 9717, 127220, 49852, 12399, 2174, 8521, 10598, 5199, 8049, 111952, 99751, 7859, 11551, 2710, 11162, 38974, 349, 20609, 1559, 7940, 38, 5076, 2470, 220, 14149, 2983, 1805, 1616, 3676, 1390, 906, 15954, 1377, 29096, 245508)

    if sym == "BBAI"
        s := array.from(0.5, 0.5, 1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 2.5, 2.5, 3.0, 3.0, 3.5, 3.5, 4.0, 4.0, 4.5, 4.5, 5.0, 5.0, 5.5, 5.5, 6.0, 6.0, 7.0, 7.0, 8.0, 8.0, 9.0, 9.0, 10.0, 10.0, 11.0, 11.0, 12.0, 12.0, 13.0, 13.0, 14.0, 14.0, 15.0, 15.0, 16.0, 16.0, 17.0, 17.0)
        g := array.from(0, 540, 12680, 1894, 9940, 40783, 18111, 24768, 0, 14946, 52449, 137751, 296322, 113906, 341320, 1015905, 389836, 509910, 2245334, 1226871, 1139083, 1449272, 3218181, 2266647, 962701, 5038697, 3121395, 1126869, 48780, 705458, 2111354, 128603, 266137, 0, 0, 450210, 66771, 0, 4690, 33270, 257934, 3698, 292, 63541, 237341, 96)

    if sym == "RR"
        s := array.from(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8)
        g := array.from(0, 0, 341, 2766, 77254, 175022, 136026, 433208, 0, 720698, 142901, 0, 0, 42661, 3327, 0)

    if sym == "BMNU"
        s := array.from(2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24)
        g := array.from(13, 0, 4019, 761, 6288, 3857, 30512, 15568, 13888, 44133, 107662, 27749, 138873, 199870, 9022, 71357, 11942, 38683, 492933, 4899, 1299, 132996, 157590, 2030, 1569, 1830, 1592, 328, 312, 79, 584, 446, 0, 138, 99, 0, 0, 416, 953, 0, 1837, 692, 796, 0, 30, 576)

    if sym == "MSTU"
        s := array.from(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 25, 25)
        g := array.from(0, 0, 0, 0, 0, 0, 0, 0, 0, 30063, 0, 0, 0, 0, 0, 0, 18256, 221, 36127, 5808, 178775, 40517, 6442, 794, 0, 11481, 1533, 0, 0, 59536, 493, 0, 0, 0, 0, 0, 4908, 0, 36, 21459, 0, 0, 0, 30, 29024, 0)

    if sym == "OPEN"
        s := array.from(0.5, 0.5, 1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 2.5, 2.5, 3.0, 3.0, 3.5, 3.5, 4.0, 4.0, 4.5, 4.5, 5.0, 5.0, 5.5, 5.5, 6.0, 6.0, 7.0, 7.0, 8.0, 8.0, 9.0, 9.0, 10.0, 10.0, 11.0, 11.0, 12.0, 12.0, 13.0, 13.0, 14.0, 14.0, 15.0, 15.0, 16.0, 16.0, 17.0, 17.0, 18.0, 18.0, 19.0, 19.0, 20.0, 20.0, 21.0, 21.0)
        g := array.from(1899, 5112, 69, 14, 76526, 32729, 74, 449, 163457, 52005, 4820, 9320, 70349, 97445, 5063, 69744, 566881, 81064, 37794, 619241, 294437, 235826, 124048, 846727, 672106, 1346187, 1072289, 86976, 20606, 1578137, 742240, 0, 359660, 269, 0, 48552, 7581, 0, 0, 15251, 29509, 0, 4871, 5534, 28531, 0, 0, 137213, 15628, 0, 0, 357233, 1292925, 0)

    // -- AUTO-GENERATED DATA BLOCKS END --
    [s, g]

// === MAIN LOGIC ===
if barstate.islast
    // 1. CLEAR OLD DRAWINGS
    // This is crucial. We wipe the screen of our specific objects every frame
    // so they don't 'detach' from the price during scrolls/updates.
    while array.size(drawn_lines) > 0
        line.delete(array.pop(drawn_lines))
    while array.size(drawn_labels) > 0
        label.delete(array.pop(drawn_labels))

    [strikes, gex_vals] = load_data()
    
    if array.size(strikes) > 0
        float max_gex = 0.0
        float total_gex = 0.0

        // Calculate Max/Total first
        for i = 0 to array.size(gex_vals) - 1
            val = array.get(gex_vals, i)
            total_gex += val
            if math.abs(val) > max_gex
                max_gex := math.abs(val)

        // === Improved Gamma Visualization ===
        // We use 'time' + milliseconds for X-axis to lock drawings to specific moments in time.
        // This prevents them from sliding around when bar indices change.
        int time_start = time
        int time_end = time + (1000 * 60 * 60 * 24 * 3) // Extend 3 days into future

        for i = 0 to array.size(strikes) - 1
            s_price = array.get(strikes, i)
            g_val = array.get(gex_vals, i)

            // Draw line for each strike
            color bar_color = g_val > 0 ? color.new(color.green, 0) : color.new(color.red, 0)
            color label_color = g_val > 0 ? color.green : color.red
            
            // Draw Line using xloc.bar_time
            line l = line.new(time_start, s_price, time_end, s_price, xloc=xloc.bar_time, color=bar_color, width=2)
            array.push(drawn_lines, l)

            // Label Logic
            if math.abs(g_val) >= text_size_threshold
                // Stagger logic in TIME (X-axis)
                // 1 bar approx 1 day on daily, but to be safe we use raw time offsets
                int x_offset_ms = (i % 2 == 0) ? (1000 * 60 * 60 * 12) : (1000 * 60 * 60 * 36) // 12h vs 36h offset
                
                string txt = str.tostring(s_price) + "\n" + str.tostring(math.round(g_val / 1000000)) + "M"
                
                label lbl = label.new(time + x_offset_ms, s_price, txt, xloc=xloc.bar_time, style=label.style_label_left,
                          textcolor=color.white, color=color.new(label_color, 40), size=size.normal)
                array.push(drawn_labels, lbl)

        // === Dashboard Summary ===
        if show_dashboard
            string regime = total_gex > 0 ? "Short Vol (Pos GEX)" : "Long Vol (Neg GEX)"
            color reg_col = total_gex > 0 ? color.green : color.red
            var table dash = table.new(position.top_right, 1, 1)
            table.cell(dash, 0, 0,
                syminfo.ticker + " GEX: " + str.tostring(math.round(total_gex/1000000)) +
                "M\n" + regime + "\nDate: 20251221",
                text_color=color.white, bgcolor=color.new(reg_col, 80))
    else
        var table err = table.new(position.bottom_right, 1, 1)
        table.cell(err, 0, 0, "No GEX Data for " + syminfo.ticker,
                   text_color=color.white, bgcolor=color.gray)
