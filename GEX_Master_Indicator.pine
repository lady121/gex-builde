//@version=6
indicator("GEX Master Auto: 20251222", overlay=true, max_boxes_count=500, max_labels_count=500)

// === SETTINGS ===
var float width_scale = input.float(0.5, "Bar Width Scale", minval=0.1, step=0.1)
var float text_size_threshold = input.float(100000000, "Text Label Threshold (Notional)")
var bool show_dashboard = input.bool(true, "Show Dashboard")

// === DATA LOADING ===
load_data() =>
    string sym = syminfo.ticker
    float[] s = array.new_float(0)
    float[] g = array.new_float(0)
    // -- AUTO-GENERATED DATA BLOCKS START --
    if sym == "SPY"
        s := array.from(210, 210, 215, 215, 220, 220, 225, 225, 230, 230, 235, 235, 240, 240, 245, 250, 250, 255, 255, 260, 260, 265, 270, 270, 275, 275, 280, 280, 285, 290, 290, 295, 295, 300, 300, 305, 305, 310, 310, 315, 315, 320, 320, 325, 325, 330, 330, 335, 335, 340, 340, 345, 345, 350, 350, 355, 355, 360, 360, 365, 365, 370, 370, 375, 375, 380, 380, 385, 385, 390, 390, 395, 395, 400, 400, 405, 405, 410, 410, 415, 415, 420, 420, 425, 425, 430, 430, 435, 435, 440, 440, 445, 445, 450, 450, 455, 455, 460, 460, 465, 465, 470, 470, 475, 475, 480, 480, 485, 485, 490, 490, 495, 495, 500, 500, 505, 505, 510, 510, 515, 515, 520, 520, 525, 525, 530, 530, 535, 535, 540, 540, 545, 545, 550, 550, 555, 555, 560, 560, 565, 565, 570, 570, 575, 575, 580, 580, 585, 585, 590, 590, 595, 595, 600, 600, 605, 605, 610, 610, 615, 615, 620, 620, 621, 621, 622, 622, 623, 623, 624, 624, 625, 625, 626, 626, 627, 627, 628, 628, 629, 629, 630, 630, 631, 631, 632, 632, 633, 633, 634, 634, 635, 635, 636, 636, 637, 637, 638, 638, 639, 639, 640, 640, 641, 641, 642, 642, 643, 643, 644, 644, 645, 645, 646, 646, 647, 647, 648, 648, 649, 649, 650, 650, 651, 651, 652, 652, 653, 653, 654, 654, 655, 655, 656, 656, 657, 657, 658, 658, 659, 659, 660, 660, 661, 661, 662, 662, 663, 663, 664, 664, 665, 665, 666, 666, 667, 667, 668, 668, 669, 669, 670, 670, 671, 671, 672, 672, 673, 673, 674, 674, 675, 675, 676, 676, 677, 677, 678, 678, 679, 679, 680, 681, 682, 683, 684, 685, 686, 687, 688, 689, 690, 691, 692, 693, 694, 695, 696, 697, 698, 699, 700, 701, 702, 703, 704, 705, 706, 707, 708, 709, 710, 711, 712, 713, 714, 715, 716, 717, 718, 719, 720, 725, 730, 735, 740, 745, 750, 755, 760, 765, 770, 775, 780, 785, 790, 795, 800, 805, 810, 815, 820, 825, 830, 835, 840, 850, 860, 870, 875, 885, 890, 930, 935, 940, 945, 955, 970, 975, 980, 985, 995, 1000)
        g := array.from(6, 21988, 8917, 2, 5, 14902, 11088, 0, 5, 2701, 5105, 5, 8, 4735, 1905, 2995, 25, 5371, 3, 1, 4455, 876, 1, 1360, 2682, 6, 7, 2361, 1559, 1300, 0, 6227, 15, 48, 11581, 5945, 5, 2391, 1, 4599, 7, 7055, 46, 8881, 26, 3830, 40, 44, 2435, 1, 3604, 2354, 0, 14179, 10, 64, 4972, 82, 4859, 2, 5127, 1746, 4, 4260, 2, 0, 3480, 2630, 0, 5979, 2, 14337, 0, 134, 14134, 3755, 1, 17, 5819, 1805, 1, 31, 25044, 9, 3521, 3967, 5, 0, 3712, 15850, 5, 6269, 5, 32, 24639, 4, 8157, 6540, 12, 1, 2674, 28, 5978, 14532, 11, 12416, 92, 7631, 2302, 330, 7930, 69, 9715, 1649, 34907, 9103, 247, 1229, 7802, 1378, 7706, 28203, 2715, 28638, 2840, 4353, 10209, 2971, 9001, 3648, 90232, 7359, 3189, 26888, 12708, 17974, 3255, 2454, 22588, 3439, 19374, 15576, 11232, 5050, 29914, 23499, 6445, 3217, 84948, 23797, 3973, 3918, 95718, 47289, 19023, 17422, 3462, 4380, 29146, 3030, 17662, 24920, 5564, 41, 901, 8, 870, 1446, 2, 1413, 1, 30878, 3049, 3, 747, 53, 2394, 809, 84, 13, 1096, 3804, 31480, 6, 713, 2643, 1, 4, 842, 762, 4, 4628, 39077, 763, 703, 16, 1336, 828, 7, 8, 826, 47780, 17025, 7, 719, 11688, 683, 7, 28055, 17436, 717, 8276, 24950, 24434, 7, 2, 24468, 727, 24, 19, 7852, 78638, 28729, 16, 10520, 1360, 19, 29, 15538, 14503, 37, 7969, 29275, 1265, 14, 7, 2397, 23, 1685, 1917, 14, 9769, 50452, 16, 1025, 918, 23, 8, 736, 14, 1060, 23818, 12705, 60, 1241, 1025, 51, 30, 660, 855, 39, 13964, 34756, 577, 67, 182, 1201, 4696, 230, 535, 1659, 22858, 19069, 1093, 1362, 1565, 1360, 2436, 2485, 2116, 2076, 25873, 1359, 2680, 1097, 2312, 23151, 2747, 2734, 2747, 2837, 27342, 1753, 1048, 3295, 1753, 20580, 1947, 1243, 2032, 2123, 48112, 2961, 2870, 2869, 2721, 21393, 1915, 1159, 1841, 913, 24904, 1179, 1321, 994, 1012, 16428, 508, 828, 1037, 519, 18410, 19224, 18777, 20611, 20887, 10426, 19340, 4054, 4591, 2873, 13367, 3304, 4188, 1307, 5419, 3647, 18488, 2436, 7866, 5189, 3699, 11204, 6957, 9844, 33718, 40, 0, 0, 0, 0, 0, 1, 0, 0, 0, 8, 736, 485, 230, 92, 142, 2964)

    if sym == "QQQ"
        s := array.from(174.78, 174.78, 179.78, 179.78, 184.78, 184.78, 189.78, 189.78, 194.78, 194.78, 199.78, 199.78, 204.78, 204.78, 209.78, 209.78, 214.78, 219.78, 224.78, 229.78, 229.78, 234.78, 234.78, 239.78, 239.78, 244.78, 249.78, 254.78, 259.78, 264.78, 269.78, 274.78, 274.78, 279.78, 284.78, 289.78, 289.78, 294.78, 299.78, 299.78, 304.78, 309.78, 309.78, 314.78, 314.78, 319.78, 319.78, 324.78, 324.78, 329.78, 329.78, 334.78, 334.78, 339.78, 339.78, 344.78, 349.78, 349.78, 354.78, 354.78, 359.78, 359.78, 364.78, 364.78, 369.78, 369.78, 370.0, 370.0, 374.78, 374.78, 379.78, 379.78, 380.0, 380.0, 384.78, 384.78, 389.78, 389.78, 390.0, 390.0, 394.78, 394.78, 399.78, 399.78, 400.0, 400.0, 404.78, 404.78, 409.78, 409.78, 410.0, 410.0, 414.78, 414.78, 419.78, 419.78, 420.0, 420.0, 424.78, 424.78, 429.78, 429.78, 430.0, 430.0, 434.78, 434.78, 439.78, 439.78, 440.0, 440.0, 444.78, 444.78, 449.78, 449.78, 450.0, 450.0, 454.78, 454.78, 459.78, 460.0, 460.0, 464.78, 464.78, 469.78, 470.0, 470.0, 474.78, 474.78, 479.78, 479.78, 480.0, 480.0, 484.78, 484.78, 489.78, 489.78, 490.0, 490.0, 494.78, 494.78, 499.78, 499.78, 500.0, 500.0, 504.78, 504.78, 509.78, 509.78, 510.0, 510.0, 514.78, 514.78, 519.78, 519.78, 520.0, 520.0, 524.78, 524.78, 529.78, 529.78, 530.0, 530.0, 534.78, 534.78, 539.78, 539.78, 540.0, 540.0, 544.78, 544.78, 549.78, 549.78, 550.0, 550.0, 554.78, 554.78, 559.78, 559.78, 560.0, 560.0, 564.78, 564.78, 569.78, 569.78, 570.0, 570.0, 574.78, 574.78, 579.78, 579.78, 580.0, 580.0, 584.78, 584.78, 589.78, 589.78, 590.0, 590.0, 594.78, 594.78, 599.78, 599.78, 600.0, 600.0, 604.78, 604.78, 609.78, 609.78, 610.0, 610.0, 615.0, 615.0, 620.0, 620.0, 625.0, 625.0, 630.0, 630.0, 635.0, 635.0, 640.0, 640.0, 645.0, 645.0, 650.0, 650.0, 655.0, 655.0, 660.0, 660.0, 665.0, 665.0, 670.0, 670.0, 675.0, 675.0, 680.0, 680.0, 685.0, 685.0, 690.0, 690.0, 695.0, 700.0, 700.0, 705.0, 710.0, 715.0, 720.0, 725.0, 730.0, 735.0, 740.0, 745.0, 750.0, 750.0, 755.0, 755.0, 760.0, 760.0, 765.0, 770.0, 775.0, 780.0, 785.0, 790.0)
        g := array.from(109, 5498, 3260, 90, 14, 766, 671, 29, 5, 527, 285, 861, 796, 21, 70, 360, 2487, 703, 4695, 3399, 4, 4503, 18, 1626, 14, 2210, 3485, 570, 3756, 5053, 1985, 95, 1809, 1421, 2275, 1266, 118, 1341, 5582, 206, 2499, 1615, 89, 36, 2140, 1560, 248, 49, 3515, 1534, 50, 144, 5009, 2673, 47, 7297, 442, 7732, 48, 4097, 2271, 310, 1635, 100, 130, 2133, 3151, 169, 133, 2086, 1624, 1455, 192, 8701, 3960, 570, 2693, 2710, 2441, 308, 4111, 1569, 2168, 1067, 1797, 16347, 1768, 1859, 143, 1478, 1219, 694, 432, 2295, 4244, 199, 1454, 9667, 4260, 2448, 128, 1024, 5282, 821, 304, 805, 1327, 778, 2969, 11583, 1138, 3123, 744, 5699, 15586, 5817, 596, 14139, 1963, 18479, 3384, 3076, 349, 1999, 6572, 1852, 796, 3818, 717, 1459, 15913, 6270, 829, 4217, 2233, 308, 3172, 9038, 7800, 1244, 545, 2416, 32368, 5101, 2625, 3144, 3489, 401, 973, 19936, 8312, 730, 290, 1891, 10234, 3087, 2646, 6468, 2561, 1283, 10040, 30234, 5706, 859, 783, 4098, 21203, 3384, 2606, 10763, 4735, 1192, 19684, 55879, 5138, 1284, 7178, 5460, 33051, 588, 2778, 6155, 5027, 2376, 530, 30376, 3182, 14139, 4272, 2468, 1598, 43685, 11699, 2435, 3322, 5679, 36343, 3850, 5883, 7999, 3685, 3953, 28215, 66215, 15281, 13397, 2885, 3945, 13830, 21881, 16538, 15210, 26007, 11407, 16627, 29557, 33180, 11419, 6907, 19170, 33038, 7441, 403, 6180, 40366, 2470, 368, 19022, 9136, 931, 94, 9801, 16117, 36, 44, 12415, 14919, 42, 41, 5789, 8056, 0, 1042, 16754, 1, 8825, 2909, 19547, 3727, 10299, 2509, 15578, 10229, 1592, 30462, 3, 0, 3725, 39084, 0, 771, 7091, 1926, 3776, 3465, 35856)

    if sym == "BITO"
        s := array.from(3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40, 40, 41, 41, 42, 42, 43, 43, 44, 44, 45, 45, 46, 46, 47, 47, 48, 48, 49, 49, 50, 50)
        g := array.from(0, 21405, 88, 1, 5, 6197, 119, 3, 0, 371, 159, 0, 124, 373, 6921, 152, 90, 713, 3800, 2408, 3521, 2803, 2707, 7468, 6468, 5161, 2448, 6781, 5972, 1765, 1631, 22756, 5225, 1863, 5864, 27328, 4594, 1368, 1059, 8136, 4914, 1353, 610, 5320, 21748, 3349, 373, 1663, 4154, 579, 282, 3213, 938, 8, 1604, 19648, 1915, 255, 73, 658, 803, 372, 146, 518, 3458, 19257, 1115, 289, 431, 299, 1672, 134, 0, 226, 5305, 18, 448, 172, 1022, 180, 3, 784, 106, 2, 17, 3642, 128, 82, 78, 167, 179, 70, 770, 266, 11234, 9978)

    if sym == "BBAI"
        s := array.from(0.5, 0.5, 1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 2.5, 2.5, 3.0, 3.0, 3.5, 3.5, 4.0, 4.0, 4.5, 4.5, 5.0, 5.0, 5.5, 5.5, 6.0, 6.0, 7.0, 7.0, 8.0, 8.0, 9.0, 9.0, 10.0, 10.0, 11.0, 11.0, 12.0, 12.0, 13.0, 13.0, 14.0, 14.0, 15.0, 15.0, 16.0, 16.0, 17.0, 17.0)
        g := array.from(412, 869, 4081, 762, 1318, 7292, 1943, 2516, 2209, 1716, 3377, 5180, 9934, 3594, 5851, 17209, 3821, 5051, 15823, 8590, 6830, 8589, 18778, 13262, 7229, 39302, 35591, 13140, 891, 11605, 48526, 3568, 8747, 193, 203, 18571, 3466, 143, 204, 1726, 20744, 77, 1, 4869, 22465, 3)

    if sym == "RR"
        s := array.from(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8)
        g := array.from(2, 0, 11, 83, 915, 1783, 1231, 3993, 473, 9319, 2823, 113, 0, 1089, 124, 1)

    if sym == "MSTU"
        s := array.from(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 25, 25)
        g := array.from(0, 0, 0, 0, 0, 0, 0, 0, 0, 1078, 0, 0, 6, 5, 30, 0, 141, 1743, 383, 62, 1273, 395, 106, 7, 5, 145, 21, 2, 0, 1017, 9, 1, 0, 0, 0, 0, 112, 0, 1, 513, 0, 0, 0, 1, 1276, 0)

    if sym == "OPEN"
        s := array.from(1.0, 1.0, 2.0, 2.0, 2.5, 2.5, 3.0, 3.0, 3.5, 3.5, 4.0, 4.0, 4.5, 4.5, 5.0, 5.0, 5.5, 5.5, 6.0, 6.0, 7.0, 7.0, 8.0, 8.0, 9.0, 9.0, 10.0, 10.0, 11.0, 11.0, 12.0, 12.0, 13.0, 13.0, 14.0, 14.0, 15.0, 15.0, 16.0, 16.0)
        g := array.from(5, 37, 16, 46, 14540, 4626, 573, 227, 6241, 2560, 2308, 121, 4187, 9656, 6902, 457, 2840, 8391, 911, 5170, 4298, 10167, 8783, 788, 20922, 312, 242, 13014, 8953, 12, 22, 2218, 0, 199, 662, 61, 0, 1890, 422, 200)

    // -- AUTO-GENERATED DATA BLOCKS END --
    [s, g]

// === MAIN LOGIC ===
// Stable price-anchored horizontal GEX visualization (support/resistance-like)
if barstate.islastconfirmedhistory
    [strikes, gex_vals] = load_data()
    if array.size(strikes) > 0
        float total_gex = 0.0
        for i = 0 to array.size(gex_vals) - 1
            total_gex += array.get(gex_vals, i)

        // store persistent drawings
        var line[] gex_lines = array.new_line()
        var label[] gex_labels = array.new_label()

        if barstate.isfirst
            for l in gex_lines
                line.delete(l)
            for lb in gex_labels
                label.delete(lb)
            array.clear(gex_lines)
            array.clear(gex_labels)

            // ðŸŸ¢ draw price-anchored GEX lines like S/R levels
            for i = 0 to array.size(strikes) - 1
                s_price = array.get(strikes, i)
                g_val = array.get(gex_vals, i)
                color g_col = g_val > 0 ? color.new(color.green, 0) : color.new(color.red, 0)

                // === anchored horizontal line ===
                l = line.new(
                    x1=bar_index - 500,
                    y1=s_price,
                    x2=bar_index + 500,
                    y2=s_price,
                    xloc=xloc.bar_index,
                    extend=extend.right,
                    color=g_col,
                    width=2)
                array.push(gex_lines, l)

                // === label fixed to that price level ===
                lb = label.new(
                    x=bar_index,
                    y=s_price,
                    text="Strike: " + str.tostring(s_price) + "\n" + str.tostring(math.round(g_val / 1e6)) + "M",
                    xloc=xloc.bar_index,
                    yloc=yloc.price,
                    style=label.style_label_left,
                    textcolor=color.white,
                    color=color.new(g_col, 70),
                    size=size.small)
                array.push(gex_labels, lb)

        // === Dashboard Summary ===
        if show_dashboard
            string regime = total_gex > 0 ? "Short Vol (Pos GEX)" : "Long Vol (Neg GEX)"
            color reg_col = total_gex > 0 ? color.green : color.red
            var table dash = table.new(position.top_right, 1, 1)
            table.cell(dash, 0, 0,
                syminfo.ticker + " GEX: " + str.tostring(math.round(total_gex/1e6)) +
                "M\n" + regime + "\nDate: 20251222",
                text_color=color.white, bgcolor=color.new(reg_col, 80))
    else
        var table err = table.new(position.bottom_right, 1, 1)
        table.cell(err, 0, 0, "No GEX Data for " + syminfo.ticker,
                   text_color=color.white, bgcolor=color.gray)
