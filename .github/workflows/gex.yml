name: Build Daily GEX + Auto Pine Update

on:
  schedule:
    # Run after market close (10:30 PM UTC = 5:30 PM ET)
    - cron: "30 22 * * 1-5"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          pip install pandas requests

      - name: ‚öôÔ∏è Run GEX Builder
        env:
          MARKETDATA_KEY: ${{ secrets.MARKETDATA_KEY }}
        run: |
          echo "=== RUNNING GEX BUILDER ==="
          mkdir -p logs
          python gex_builder.py > logs/gex_builder_$(date +'%Y%m%d_%H%M').log 2>&1 || true
          echo "=== GEX BUILDER COMPLETE ==="

      - name: ‚ú® Generate TradingView Pine Script
        run: |
          echo "=== GENERATING GEX MASTER INDICATOR ==="
          python gex_to_tradingview.py > logs/pine_generator_$(date +'%Y%m%d_%H%M').log 2>&1 || true
          echo "=== PINE SCRIPT GENERATED ==="

      - name: üßπ Commit & Push Updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add *.csv latest.txt GEX_Master_Indicator.pine logs/ || true

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No new data to commit."
          else
            git commit -m "Daily Auto-Update: CSVs + Pine Script $(date)"
            git push
            echo "‚úÖ Data & Pine script committed successfully."
          fi
