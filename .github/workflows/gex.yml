name: Build Daily GEX CSVs (Stable Original Mode)

on:
  schedule:
    # Run every weekday after market close (10:30 PM UTC = 5:30 PM ET)
    - cron: "30 22 * * 1-5"
  workflow_dispatch:  # allows manual runs

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # allows workflow to push commits to repo

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch entire history for proper commits

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          pip install pandas requests

      - name: ‚öôÔ∏è Run GEX Builder
        env:
          MARKETDATA_TOKEN: ${{ secrets.MARKETDATA_TOKEN }}
        run: |
          echo "=== RUNNING GEX BUILDER ==="
          mkdir -p logs
          python gex_builder.py > logs/gex_builder_$(date +'%Y%m%d_%H%M').log 2>&1
          echo "=== GEX BUILDER COMPLETE ==="

      - name: üßπ Commit & Push CSV Updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Add only relevant files
          git add *.csv latest.txt logs/

          # If there are changes, commit and push
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No new data to commit."
          else
            git commit -m "Daily GEX CSV update $(date)"
            git push
            echo "‚úÖ Changes committed and pushed."
          fi
